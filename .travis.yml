sudo: required
language: c
services: docker
cache: ccache

env:
  global:
    - DOCKERHUB_IMG=yhnw/openwrt-sdk
    - PKG_NAME=lv
    - QUIET=1 # 1: suppress build log / "": output all
  matrix:
    - DISTRO=openwrt-15.05.1 ARCH=ar71xx PKG_DIR=bin/ar71xx/packages
    - DISTRO=lede-17.01.2    ARCH=ar71xx PKG_DIR=bin/packages/mips_24kc

before_install:
  - docker version
  - ccache -s | tee ccache.log
  - mkdir $PWD/pkgs
  - chmod 777 $PWD/pkgs
  - chmod -R 777 $HOME/.ccache

script:
  - docker run --rm -u openwrt -v $PWD:/work -v $HOME/.ccache:/home/openwrt/.ccache ${DOCKERHUB_IMG}:${DISTRO}-${ARCH} /bin/bash /work/build.sh ${DISTRO}-${ARCH} $PKG_DIR $PKG_NAME $QUIET
  - ls -la
  - |
    echo '### before build ###' &&
    cat ccache.log &&
    echo &&
    echo '### after build ###' &&
    ccache -s

after_failure:
  - if [[ -e pkgs/build.log ]]; then tail -300 pkgs/build.log; fi

before_deploy:
  - |
    if [[ -n "$TRAVIS_TAG" ]]; then
      export VERSION=stable;
      export VCS_TAG="$TRAVIS_TAG";
      export DESC="Stable release";
      export UPLOAD_DIR_SUFFIX=;
    else
      export VERSION=develop;
      export VCS_TAG=HEAD;
      export DESC="Development snapshot";
      export UPLOAD_DIR_SUFFIX=-dev;
    fi
  - export RELEASED=$(date +%Y-%m-%d);

deploy:
  - provider: releases
    api_key:
      secure: "VRGDNaprLPD6YenK6vSS6bEi9eQW8BKbQe9SHvPYPXqM3ZUmJya5tw99j7ilDY+vaZ+KK9kBxF/Zf1XPHjng0D4jyXaS+Ij7Hh3clCKIDnA/+n99DU2I+l9EAb1pjhHdFrpu6zUhEw7gSpMB4v2SK/iZPWDBUaZnTS802jfbe8gxPmHcOlFeEi2cj7ldpENyM9VZBbVy4VRrBiyNXl5Y/4z/rezp06gzfYEFDKpCErqnIukcvQ+np2ydFvdxG5wWMoGmt7VpH4AXTU08xA+onuUxLF6VxX9apLbhlhLSzxqTqairrCakurqNYj5PsijDp/RawjItLazjn93es5qdQJOKditFmQoi2C4EASKtM9XO0RYykmCTczhO+/lJlT36HpU5mEM6AE2KZHs/KgDlpQLC/r6YqOFRnkk3lzZwMXm9P5mpBF+3u+KQ90Zs6jdUoLvkP2k90Jeqhlz+bSmqfznN7t29HdZD1TGJftslpOWV7GBE3LI41AhIOjB/5wkumBBc/hFf2a5xkK+iSwC0Qe77QQxhIV8hglgbWGxgbBSdwKeKAwN7oozWbIDcULDcWeBcDZNFendlEU/6Jt1LUeu7RdpXGZ8AMUwQCgKW4gZCMuBDAv+Z2fu1RjEAr4YrBODE4tyxCaoNeswzXOBtt4+oMTcCksuvl0voQNrRzl4="
    file_glob: true
    file: "pkgs/for-github/*.ipk"
    skip_cleanup: true
    on:
      tags: true
